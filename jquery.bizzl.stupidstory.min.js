// Copyright (c) 2010 Benjamin Kleiner
// Licensed under MIT License: http://www.opensource.org/licenses/mit-license.php
(function($){var onKeyPress=function(event){var currentVar=$(this).data("stupidStory.currentVar");var vars=$(this).data("stupidStory.vars");var prompts=$(this).data("stupidStory.prompts");var blocks=$(this).data("stupidStory.textBlocks");if(event.which==13){if($(this).find(".prompt").length>0){$(this).find(".prompt").remove();}var text=$(this).html();if(currentVar){text+=vars[currentVar];currentVar="";}while(blocks.length>0){var line=blocks.shift();if(line in prompts){if(line in vars){text+=vars[line];}else{currentVar=line;break;}}else{text+=line;}}$(this).html(text);if(!blocks.length&&!currentVar){$(this).stupidStory(false);return;}$(this).data("stupidStory.currentVar",currentVar);}if(currentVar){if(!vars[currentVar]){vars[currentVar]="";}if(event.which>31){vars[currentVar]=vars[currentVar]+String.fromCharCode(event.which);}else{if(event.which==8&&vars[currentVar]&&vars[currentVar].length>0){vars[currentVar]=vars[currentVar].substr(0,vars[currentVar].length-1);}}var p=$(this).find(".prompt");p=p.length>0?p:$('<span class="prompt"></span>').appendTo(this);p.text(vars[currentVar]?vars[currentVar]:prompts[currentVar]);}};var onClick=function(event){if(typeof($(this).attr("tabindex"))=="undefined"){$(this).attr("tabindex",-1);}this.focus();};$.fn.stupidStory=function(text,vars){return this.each(function(){if(text==false){return $(this).removeData("stupidStory.currentVar").removeData("stupidStory.textBlocks").removeData("stupidStory.prompts").removeData("stupidStory.vars").unbind("keypress",onKeyPress).unbind("click",onClick);}var rex=[];for(i in vars){rex.push(i);}rex.sort(function(a,b){return(a<b)?1:-1;});var blocks=text.split(new RegExp("\\$("+rex.join("|")+")","g"));return $(this).data("stupidStory.currentVar","").data("stupidStory.textBlocks",blocks).data("stupidStory.prompts",vars).data("stupidStory.vars",{}).keypress(onKeyPress).click(onClick).trigger($.extend($.Event("keypress"),{which:13}));});};})(jQuery);
